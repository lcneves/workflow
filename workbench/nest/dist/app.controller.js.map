{"version":3,"sources":["../src/app.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Get,\n  HttpCode,\n  HttpException,\n  HttpStatus,\n  Post,\n  Query,\n  Res,\n} from '@nestjs/common';\nimport type { Response } from 'express';\nimport { getHookByToken, getRun, resumeHook, start } from 'workflow/api';\nimport {\n  WorkflowRunFailedError,\n  WorkflowRunNotCompletedError,\n} from 'workflow/internal/errors';\nimport { hydrateWorkflowArguments } from 'workflow/internal/serialization';\nimport { allWorkflows } from './lib/_workflow.js';\n\n@Controller('api')\nexport class AppController {\n  @Post('hook')\n  @HttpCode(200)\n  async resumeWorkflowHook(@Body() body: { token: string; data: any }) {\n    const { token, data } = body;\n\n    let hook: Awaited<ReturnType<typeof getHookByToken>>;\n    try {\n      hook = await getHookByToken(token);\n      console.log('hook', hook);\n    } catch (error) {\n      console.log('error during getHookByToken', error);\n      // TODO: `WorkflowAPIError` is not exported, so for now\n      throw new HttpException(null, HttpStatus.NOT_FOUND);\n    }\n\n    await resumeHook(hook.token, {\n      ...data,\n      // @ts-expect-error metadata is not typed\n      customData: hook.metadata?.customData,\n    });\n\n    return hook;\n  }\n\n  @Post('trigger')\n  async startWorkflowRun(\n    @Query('workflowFile') workflowFile: string = 'workflows/99_e2e.ts',\n    @Query('workflowFn') workflowFn: string = 'simple',\n    @Query('args') argsParam: string | undefined,\n    @Body() bodyData: any\n  ) {\n    if (!workflowFile) {\n      throw new HttpException(\n        'No workflowFile query parameter provided',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n    const workflows = allWorkflows[workflowFile as keyof typeof allWorkflows];\n    if (!workflows) {\n      throw new HttpException(\n        `Workflow file \"${workflowFile}\" not found`,\n        HttpStatus.BAD_REQUEST\n      );\n    }\n\n    if (!workflowFn) {\n      throw new HttpException(\n        'No workflow query parameter provided',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n    const workflow = workflows[workflowFn as keyof typeof workflows];\n    if (!workflow) {\n      throw new HttpException(\n        `Workflow \"${workflowFn}\" not found`,\n        HttpStatus.BAD_REQUEST\n      );\n    }\n\n    let args: any[] = [];\n\n    // Args from query string\n    if (argsParam) {\n      args = argsParam.split(',').map((arg) => {\n        const num = parseFloat(arg);\n        return Number.isNaN(num) ? arg.trim() : num;\n      });\n    } else if (bodyData && Object.keys(bodyData).length > 0) {\n      // Args from body\n      args = hydrateWorkflowArguments(bodyData, globalThis);\n    } else {\n      args = [42];\n    }\n    console.log(`Starting \"${workflowFn}\" workflow with args: ${args}`);\n\n    try {\n      const run = await start(workflow as any, args as any);\n      console.log('Run:', run);\n      return run;\n    } catch (err) {\n      console.error(`Failed to start!!`, err);\n      throw err;\n    }\n  }\n\n  @Get('trigger')\n  async getWorkflowRunResult(\n    @Query('runId') runId: string | undefined,\n    @Query('output-stream') outputStreamParam: string | undefined,\n    @Res() res: Response\n  ) {\n    if (!runId) {\n      throw new HttpException('No runId provided', HttpStatus.BAD_REQUEST);\n    }\n\n    if (outputStreamParam) {\n      const namespace =\n        outputStreamParam === '1' ? undefined : outputStreamParam;\n      const run = getRun(runId);\n      const stream = run.getReadable({\n        namespace,\n      });\n      // Add JSON framing to the stream, wrapping binary data in base64\n      const streamWithFraming = new TransformStream({\n        transform(chunk, controller) {\n          const data =\n            chunk instanceof Uint8Array\n              ? { data: Buffer.from(chunk).toString('base64') }\n              : chunk;\n          controller.enqueue(`${JSON.stringify(data)}\\n`);\n        },\n      });\n\n      res.setHeader('Content-Type', 'application/octet-stream');\n      const readableStream = stream.pipeThrough(streamWithFraming);\n      const reader = readableStream.getReader();\n\n      const pump = async () => {\n        const { done, value } = await reader.read();\n        if (done) {\n          res.end();\n          return;\n        }\n        res.write(value);\n        await pump();\n      };\n      await pump();\n      return;\n    }\n\n    try {\n      const run = getRun(runId);\n      const returnValue = await run.returnValue;\n      console.log('Return value:', returnValue);\n\n      // Include run metadata in headers\n      const [createdAt, startedAt, completedAt] = await Promise.all([\n        run.createdAt,\n        run.startedAt,\n        run.completedAt,\n      ]);\n\n      res.setHeader(\n        'X-Workflow-Run-Created-At',\n        createdAt?.toISOString() || ''\n      );\n      res.setHeader(\n        'X-Workflow-Run-Started-At',\n        startedAt?.toISOString() || ''\n      );\n      res.setHeader(\n        'X-Workflow-Run-Completed-At',\n        completedAt?.toISOString() || ''\n      );\n\n      if (returnValue instanceof ReadableStream) {\n        res.setHeader('Content-Type', 'application/octet-stream');\n        const reader = returnValue.getReader();\n        const pump = async () => {\n          const { done, value } = await reader.read();\n          if (done) {\n            res.end();\n            return;\n          }\n          res.write(value);\n          await pump();\n        };\n        await pump();\n        return;\n      }\n\n      return res.json(returnValue);\n    } catch (error) {\n      if (error instanceof Error) {\n        if (WorkflowRunNotCompletedError.is(error)) {\n          return res.status(HttpStatus.ACCEPTED).json({\n            ...error,\n            name: error.name,\n            message: error.message,\n          });\n        }\n\n        if (WorkflowRunFailedError.is(error)) {\n          const cause = error.cause as any;\n          return res.status(HttpStatus.BAD_REQUEST).json({\n            ...error,\n            name: error.name,\n            message: error.message,\n            cause: {\n              message: cause.message,\n              stack: cause.stack,\n              code: cause.code,\n            },\n          });\n        }\n      }\n\n      console.error(\n        'Unexpected error while getting workflow return value:',\n        error\n      );\n      return res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({\n        error: 'Internal server error',\n      });\n    }\n  }\n\n  @Post('test-direct-step-call')\n  async invokeStepDirectly(@Body() body: { x: number; y: number }) {\n    // This route tests calling step functions directly outside of any workflow context\n    // After the SWC compiler changes, step functions in client mode have their directive removed\n    // and keep their original implementation, allowing them to be called as regular async functions\n    const { add } = await import('./workflows/99_e2e.js');\n\n    const { x, y } = body;\n\n    console.log(`Calling step function directly with x=${x}, y=${y}`);\n\n    // Call step function directly as a regular async function (no workflow context)\n    const result = await add(x, y);\n    console.log(`add(${x}, ${y}) = ${result}`);\n\n    return { result };\n  }\n}\n"],"names":["AppController","resumeWorkflowHook","body","token","data","hook","getHookByToken","console","log","error","HttpException","HttpStatus","NOT_FOUND","resumeHook","customData","metadata","startWorkflowRun","workflowFile","workflowFn","argsParam","bodyData","BAD_REQUEST","workflows","allWorkflows","workflow","args","split","map","arg","num","parseFloat","Number","isNaN","trim","Object","keys","length","hydrateWorkflowArguments","globalThis","run","start","err","getWorkflowRunResult","runId","outputStreamParam","res","namespace","undefined","getRun","stream","getReadable","streamWithFraming","TransformStream","transform","chunk","controller","Uint8Array","Buffer","from","toString","enqueue","JSON","stringify","setHeader","readableStream","pipeThrough","reader","getReader","pump","done","value","read","end","write","returnValue","createdAt","startedAt","completedAt","Promise","all","toISOString","ReadableStream","json","Error","WorkflowRunNotCompletedError","is","status","ACCEPTED","name","message","WorkflowRunFailedError","cause","stack","code","INTERNAL_SERVER_ERROR","invokeStepDirectly","add","x","y","result"],"mappings":"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"}
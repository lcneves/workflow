{"version":3,"sources":["../../src/workflows/5_hooks.ts"],"sourcesContent":["import OpenAI from 'openai';\nimport { createHook, getStepMetadata, getWorkflowMetadata } from 'workflow';\n\n/**\n * `getStepMetadata()` is a hook that allows you to access the step's context\n * of the current workflow run.\n *\n * It is useful for accessing the context of the current workflow run, such as\n * the workflow run ID, the workflow started at, and the attempt number.\n */\nasync function stepWithGetMetadata() {\n  'use step';\n  const ctx = getStepMetadata();\n  console.log('step context', ctx);\n\n  // Mimic a retryable error 50% of the time (so that the `attempt` counter increases)\n  if (Math.random() < 0.5) {\n    throw new Error('Retryable error');\n  }\n\n  return ctx;\n}\n\nexport async function withWorkflowMetadata() {\n  'use workflow';\n  const ctx = getWorkflowMetadata();\n  console.log('workflow context', ctx);\n\n  const stepCtx = await stepWithGetMetadata();\n\n  return { workflowCtx: ctx, stepCtx };\n}\n\nasync function initiateOpenAIResponse() {\n  'use step';\n  const openai = new OpenAI();\n  const resp = await openai.responses.create({\n    model: 'o3',\n    input: 'Write a very long novel about otters in space.',\n    background: true,\n  });\n  console.log('OpenAI response:', resp);\n  return resp.id;\n}\n\nasync function getOpenAIResponse(respId: string): Promise<string> {\n  'use step';\n  const openai = new OpenAI();\n  const resp = await openai.responses.retrieve(respId);\n  return resp.output_text;\n}\n\n/**\n * `createHook()` registers a token that can be used to resume the workflow run.\n * The token can be passed to external services as a callback URL, or used\n * for human-in-the-loop workflows by, for example, including in an email.\n *\n * The workflow run will be suspended until the hook is invoked.\n */\nexport async function withCreateHook() {\n  'use workflow';\n\n  // Initiate a background \"Response\" request to OpenAI,\n  // which will invoke the hook when it's done.\n  const respId = await initiateOpenAIResponse();\n\n  // Register the hook with the token that is specific\n  // to the response ID that we are interested in.\n  const hook = createHook<{ type: string; data: { id: string } }>({\n    token: `openai:${respId}`,\n  });\n  console.log('Registered hook:', hook.token);\n\n  // Wait for the hook to be called.\n  const payload = await hook;\n  console.log('Received hook payload:', payload);\n\n  if (payload.type === 'response.completed') {\n    const text = await getOpenAIResponse(payload.data.id);\n    console.log('OpenAI response text:', text);\n  }\n\n  console.log('Hook demo workflow completed');\n}\n"],"names":["withCreateHook","withWorkflowMetadata","stepWithGetMetadata","ctx","getStepMetadata","console","log","Math","random","Error","initiateOpenAIResponse","openai","OpenAI","resp","responses","create","model","input","background","id","getOpenAIResponse","respId","retrieve","output_text"],"mappings":";;;;;;;;;;;;IA2DsBA,cAAc;eAAdA;;IApCAC,oBAAoB;eAApBA;;;AApBtB;;;;;;CAMC,GACD,eAAeC;IAEb,MAAMC,MAAMC;IACZC,QAAQC,GAAG,CAAC,gBAAgBH;IAE5B,oFAAoF;IACpF,IAAII,KAAKC,MAAM,KAAK,KAAK;QACvB,MAAM,IAAIC,MAAM;IAClB;IAEA,OAAON;AACT;AAEO,eAAeF;;AAQtB;;AAEA,eAAeS;IAEb,MAAMC,SAAS,IAAIC;IACnB,MAAMC,OAAO,MAAMF,OAAOG,SAAS,CAACC,MAAM,CAAC;QACzCC,OAAO;QACPC,OAAO;QACPC,YAAY;IACd;IACAb,QAAQC,GAAG,CAAC,oBAAoBO;IAChC,OAAOA,KAAKM,EAAE;AAChB;AAEA,eAAeC,kBAAkBC,MAAc;IAE7C,MAAMV,SAAS,IAAIC;IACnB,MAAMC,OAAO,MAAMF,OAAOG,SAAS,CAACQ,QAAQ,CAACD;IAC7C,OAAOR,KAAKU,WAAW;AACzB;AASO,eAAevB;;AAwBtB"}
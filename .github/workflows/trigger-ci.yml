name: Trigger CI for External PRs

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  trigger-ci:
    name: Trigger CI Run
    # Only run on PR comments
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/run-ci')
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if commenter has admin permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const script = require('./.github/scripts/check-permissions.js');
            return await script({ github, context });
      
      - name: Exit if unauthorized
        if: steps.check-permissions.outputs.result != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/post-unauthorized-comment.js');
            await script({ github, context, core });
      
      - name: Get PR details
        if: steps.check-permissions.outputs.result == 'true'
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/get-pr-details.js');
            return await script({ github, context });
      
      - name: Checkout repo
        if: steps.check-permissions.outputs.result == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create CI branch and PR
        if: steps.check-permissions.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/create-ci-pr.js');
            const prDetails = ${{ steps.pr-details.outputs.result }};
            await script({ github, context, core, exec }, prDetails);


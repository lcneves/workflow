---
title: 工作流中的 fetch
---

当你尝试在工作流函数中直接使用 `fetch()`，或当一个库（例如 AI SDK）在底层尝试调用 `fetch()` 时，会出现此错误。

## 错误信息

```
Global "fetch" is unavailable in workflow functions. Use the "fetch" step function from "workflow" to make HTTP requests.
```

## 发生原因

工作流函数在沙箱环境中运行，无法直接访问 `fetch()`。

许多库在底层会发起 HTTP 请求。例如，AI SDK 的 `generateText()` 函数会调用 `fetch()` 向 AI 提供商发送 HTTP 请求。当这些库在工作流函数内部运行时，会因为全局的 `fetch` 不可用而失败。

## 快速修复

从 `workflow` 包导入 `fetch` 步骤函数，并在你的工作流函数内部将其赋值给 `globalThis.fetch`。这个版本的 `fetch` 是一个步骤函数，它封装了标准的 `fetch` API，自动处理序列化并提供重试能力。这样也会使 `fetch()` 在当前工作流函数中的所有函数和库可用。

**之前：**

```typescript lineNumbers title="workflows/ai.ts"
import { generateText } from "ai";
import { openai } from "@ai-sdk/openai";

export async function chatWorkflow(prompt: string) {
  "use workflow";

  // Error - generateText() calls fetch() under the hood
  const result = await generateText({ // [!code highlight]
    model: openai("gpt-4"), // [!code highlight]
    prompt, // [!code highlight]
  }); // [!code highlight]

  return result.text;
}
```

**之后：**

```typescript lineNumbers title="workflows/ai.ts"
import { generateText } from "ai";
import { openai } from "@ai-sdk/openai";
import { fetch } from "workflow"; // [!code highlight]

export async function chatWorkflow(prompt: string) {
  "use workflow";

  globalThis.fetch = fetch; // [!code highlight]

  // Now generateText() can make HTTP requests via the fetch step
  const result = await generateText({
    model: openai("gpt-4"),
    prompt,
  });

  return result.text;
}
```

## 常见场景

### AI SDK 集成

这是最常见的场景 —— 使用会发起 HTTP 请求的 AI SDK 函数：

```typescript lineNumbers
import { generateText, streamText } from "ai";
import { openai } from "@ai-sdk/openai";
import { fetch } from "workflow"; // [!code highlight]

export async function aiWorkflow(userMessage: string) {
  "use workflow";

  globalThis.fetch = fetch; // [!code highlight]

  // generateText makes HTTP requests to OpenAI
  const response = await generateText({
    model: openai("gpt-4"),
    prompt: userMessage,
  });

  return response.text;
}
```

### 直接 API 调用

你也可以直接使用 fetch 步骤函数来执行自定义的 HTTP 请求：

```typescript lineNumbers
import { fetch } from "workflow";

export async function dataWorkflow() {
  "use workflow";

  // Use fetch directly for HTTP requests
  const response = await fetch("https://api.example.com/data"); // [!code highlight]
  const data = await response.json();

  return data;
}
```

有关 `fetch` 步骤函数的更多详细信息，请参阅 [fetch API 参考](/docs/api-reference/workflow/fetch).
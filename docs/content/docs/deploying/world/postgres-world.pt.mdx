---
title: Mundo PostgreSQL
---

O mundo PostgreSQL √© uma implementa√ß√£o de refer√™ncia de um [Mundo](/docs/deploying/world) que √© totalmente suportada pelo PostgreSQL, incluindo processamento de jobs (usando [pg-boss](https://github.com/timgit/pg-boss)) e streaming (usando NOTIFY e LISTEN do PostgreSQL).

Este mundo √© projetado para processos de longa execu√ß√£o, portanto pode receber e despachar eventos a partir de um banco de dados PostgreSQL, e n√£o se destina a ser implantado em plataformas serverless como o Vercel devido a essa natureza.

<Steps>

<Step>

## Instala√ß√£o

Instale o pacote `@workflow/world-postgres`:

```package-install
@workflow/world-postgres
```

</Step>

<Step>

## Adicione Vari√°veis de Ambiente

Adicione as seguintes vari√°veis de ambiente ao seu arquivo `.env` necess√°rias para workflows:

```bash
WORKFLOW_TARGET_WORLD="@workflow/world-postgres"
WORKFLOW_POSTGRES_URL="postgres://postgres:password@db.yourdb.co:5432/postgres"
WORKFLOW_POSTGRES_JOB_PREFIX="workflow_"
WORKFLOW_POSTGRES_WORKER_CONCURRENCY=10
```

A configura√ß√£o do world √© lida automaticamente a partir das vari√°veis de ambiente:

- `WORKFLOW_TARGET_WORLD` - Obrigat√≥rio, especifica qual implementa√ß√£o de world usar
- `WORKFLOW_POSTGRES_URL` - String de conex√£o do PostgreSQL (padr√£o `postgres://world:world@localhost:5432/world`)
- `WORKFLOW_POSTGRES_JOB_PREFIX` - Prefixo para nomes de jobs da fila
- `WORKFLOW_POSTGRES_WORKER_CONCURRENCY` - N√∫mero de workers concorrentes (padr√£o `10` se n√£o especificado)


</Step>

<Step>

## Configurar o esquema do banco de dados

Execute o script de configura√ß√£o para criar as tabelas de banco de dados necess√°rias:

```bash
pnpm exec workflow-postgres-setup
```

Isto criar√° as seguintes tabelas no seu banco de dados PostgreSQL:

- `workflow_runs` - Armazena o estado de execu√ß√£o dos workflows
- `workflow_events` - Armazena eventos de workflow
- `workflow_steps` - Armazena o estado dos passos do workflow
- `workflow_hooks` - Armazena hooks de workflow
- `workflow_stream_chunks` - Armazena dados de streaming

Voc√™ dever√° ver uma sa√≠da como:

```
üîß Setting up database schema...
üìç Connection: postgres://postgres:****@db.yourcloudprovider.co:5432/postgres
‚úÖ Database schema created successfully!
```

</Step>

<Step>

## Inicializar o Mundo PostgreSQL

Iniciar o Mundo PostgreSQL variar√° entre diferentes frameworks. A ideia principal √© iniciar o Mundo PostgreSQL na inicializa√ß√£o do servidor.

Aqui est√£o alguns exemplos de como isso pode ser feito:

### Next.js

Crie um arquivo `instrumentation.ts` na raiz do seu projeto para inicializar e iniciar o world:

```ts title="instrumentation.ts" lineNumbers
export async function register() {
  if (process.env.NEXT_RUNTIME !== "edge") {
    // Dynamic import to avoid edge runtime bundling issues
    console.log("Starting Postgres World...");
    const { getWorld } = await import("workflow/runtime");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
}
```

<Callout>
  Saiba mais sobre [Instrumenta√ß√£o do Next.js](https://nextjs.org/docs/app/guides/instrumentation).
</Callout>

### SvelteKit

Crie o arquivo `src/hooks.server.ts`:

```ts title="src/hooks.server.ts" lineNumbers
import type { ServerInit } from "@sveltejs/kit";

export const init: ServerInit = async () => {
  if (process.env.WORKFLOW_TARGET_WORLD === "@workflow/world-postgres") {
    // Dynamic import to avoid edge runtime bundling issues
    const { getWorld } = await import("workflow/runtime");
    console.log("Starting Postgres World...");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
};
```

<Callout>
  Saiba mais sobre [Hooks do SvelteKit](https://svelte.dev/docs/kit/hooks).
</Callout>

### Aplica√ß√µes baseadas em Nitro

Crie um plugin para iniciar o Mundo PostgreSQL. Isto ser√° invocado quando o servidor Nitro iniciar.

```ts title="plugins/start-pg-world.ts" lineNumbers
import { defineNitroPlugin } from "nitro/~internal/runtime/plugin";

export default defineNitroPlugin(async () => {
  if (process.env.WORKFLOW_TARGET_WORLD === "@workflow/world-postgres") {
    // Dynamic import to avoid edge runtime bundling issues
    console.log("Starting Postgres World...");
    const { getWorld } = await import("workflow/runtime");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
});
```

Adicione o plugin ao seu arquivo `nitro.config.ts`. Isso habilita o plugin:

```ts title="nitro.config.ts"
import { defineNitroConfig } from "nitropack";

export default defineNitroConfig({
  // ... your nitro config
  modules: ["workflow/nitro"],
  plugins: ["plugins/start-pg-world.ts"],
});
```

<Callout>
  Saiba mais sobre [Plugins do Nitro](https://v3.nitro.build/docs/plugins)
</Callout>

</Step>

</Steps>

## Como funciona

O Mundo PostgreSQL usa o PostgreSQL como backend dur√°vel para a execu√ß√£o de workflows:

- **Fila de Jobs**: Usa [pg-boss](https://github.com/timgit/pg-boss) para processamento confi√°vel de jobs
- **Streaming de Eventos**: Aproveita NOTIFY/LISTEN do PostgreSQL para distribui√ß√£o de eventos em tempo real
- **Persist√™ncia de Estado**: Todo o estado dos workflows √© armazenado em tabelas do PostgreSQL
- **Gerenciamento de workers**: Suporta workers concorrentes configur√°veis para processamento de jobs

Esta configura√ß√£o garante que seus workflows possam sobreviver a reinicializa√ß√µes e falhas da aplica√ß√£o, com todo o estado sendo persistentemente armazenado no seu banco de dados PostgreSQL.
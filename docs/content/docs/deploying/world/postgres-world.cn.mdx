---
title: Postgres ä¸–ç•Œ
---

PostgreSQL ä¸–ç•Œæ˜¯ä¸€ä¸ªå¯¹ [World](/docs/deploying/world) çš„å‚è€ƒå®ç°ï¼Œå®Œå…¨ç”± PostgreSQL é©±åŠ¨ï¼ŒåŒ…æ‹¬ä½œä¸šå¤„ç†ï¼ˆä½¿ç”¨ [pg-boss](https://github.com/timgit/pg-boss)ï¼‰å’Œæµå¤„ç†ï¼ˆä½¿ç”¨ PostgreSQL çš„ NOTIFY å’Œ LISTENï¼‰ã€‚

è¿™ä¸ª world æ—¨åœ¨ç”¨äºé•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ï¼Œå› æ­¤å®ƒå¯ä»¥ä» PostgreSQL æ•°æ®åº“æ¥æ”¶å¹¶åˆ†å‘äº‹ä»¶ï¼Œå› æ­¤ä¸é€‚åˆéƒ¨ç½²åœ¨åƒ Vercel è¿™æ ·çš„æ— æœåŠ¡å™¨å¹³å°ä¸Šã€‚

<Steps>

<Step>

## å®‰è£…

å®‰è£… `@workflow/world-postgres` åŒ…ï¼š

```package-install
@workflow/world-postgres
```

</Step>

<Step>

## æ·»åŠ ç¯å¢ƒå˜é‡

å°†ä»¥ä¸‹ä¸ºå·¥ä½œæµæ‰€éœ€çš„ç¯å¢ƒå˜é‡æ·»åŠ åˆ°ä½ çš„ `.env` æ–‡ä»¶ä¸­ï¼š

```bash
WORKFLOW_TARGET_WORLD="@workflow/world-postgres"
WORKFLOW_POSTGRES_URL="postgres://postgres:password@db.yourdb.co:5432/postgres"
WORKFLOW_POSTGRES_JOB_PREFIX="workflow_"
WORKFLOW_POSTGRES_WORKER_CONCURRENCY=10
```

world é…ç½®ä¼šè‡ªåŠ¨ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–ï¼š

- `WORKFLOW_TARGET_WORLD` - å¿…éœ€ï¼ŒæŒ‡å®šè¦ä½¿ç”¨çš„ world å®ç°
- `WORKFLOW_POSTGRES_URL` - PostgreSQL è¿æ¥å­—ç¬¦ä¸²ï¼ˆé»˜è®¤ä¸º `postgres://world:world@localhost:5432/world`ï¼‰
- `WORKFLOW_POSTGRES_JOB_PREFIX` - é˜Ÿåˆ—ä½œä¸šåç§°çš„å‰ç¼€
- `WORKFLOW_POSTGRES_WORKER_CONCURRENCY` - å¹¶å‘å·¥ä½œçº¿ç¨‹æ•°é‡ï¼ˆå¦‚æœæœªæŒ‡å®šï¼Œé»˜è®¤ä¸º `10`ï¼‰


</Step>

<Step>

## è®¾ç½®æ•°æ®åº“æ¶æ„

è¿è¡Œè®¾ç½®è„šæœ¬ä»¥åˆ›å»ºæ‰€éœ€çš„æ•°æ®åº“è¡¨ï¼š

```bash
pnpm exec workflow-postgres-setup
```

è¿™å°†åœ¨ä½ çš„ PostgreSQL æ•°æ®åº“ä¸­åˆ›å»ºä»¥ä¸‹è¡¨ï¼š

- `workflow_runs` - å­˜å‚¨å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€
- `workflow_events` - å­˜å‚¨å·¥ä½œæµäº‹ä»¶
- `workflow_steps` - å­˜å‚¨å·¥ä½œæµæ­¥éª¤çŠ¶æ€
- `workflow_hooks` - å­˜å‚¨å·¥ä½œæµé’©å­
- `workflow_stream_chunks` - å­˜å‚¨æµå¼æ•°æ®

ä½ åº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
ğŸ”§ Setting up database schema...
ğŸ“ Connection: postgres://postgres:****@db.yourcloudprovider.co:5432/postgres
âœ… Database schema created successfully!
```

</Step>

<Step>

## åˆå§‹åŒ– PostgreSQL ä¸–ç•Œ

åœ¨ä¸åŒæ¡†æ¶ä¸­å¯åŠ¨ PostgreSQL World çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚ä¸»è¦æ€æƒ³æ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨ PostgreSQL Worldã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¯èƒ½çš„ç¤ºä¾‹ï¼š

### Next.js

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `instrumentation.ts` æ–‡ä»¶ä»¥åˆå§‹åŒ–å¹¶å¯åŠ¨ worldï¼š

```ts title="instrumentation.ts" lineNumbers
export async function register() {
  if (process.env.NEXT_RUNTIME !== "edge") {
    // Dynamic import to avoid edge runtime bundling issues
    console.log("Starting Postgres World...");
    const { getWorld } = await import("workflow/runtime");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
}
```

<Callout>
  äº†è§£æœ‰å…³ [Next.js æ’è£…](https://nextjs.org/docs/app/guides/instrumentation) çš„æ›´å¤šä¿¡æ¯ã€‚
</Callout>

### SvelteKit

åˆ›å»ºæ–‡ä»¶ `src/hooks.server.ts`ï¼š

```ts title="src/hooks.server.ts" lineNumbers
import type { ServerInit } from "@sveltejs/kit";

export const init: ServerInit = async () => {
  if (process.env.WORKFLOW_TARGET_WORLD === "@workflow/world-postgres") {
    // Dynamic import to avoid edge runtime bundling issues
    const { getWorld } = await import("workflow/runtime");
    console.log("Starting Postgres World...");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
};
```

<Callout>
  äº†è§£æœ‰å…³ [SvelteKit é’©å­](https://svelte.dev/docs/kit/hooks) çš„æ›´å¤šä¿¡æ¯ã€‚
</Callout>

### åŸºäº Nitro çš„åº”ç”¨

åˆ›å»ºä¸€ä¸ªæ’ä»¶ä»¥åœ¨ Nitro æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨ PostgreSQL Worldã€‚è¯¥æ’ä»¶å°†åœ¨ Nitro æœåŠ¡å™¨å¯åŠ¨æ—¶è¢«è°ƒç”¨ã€‚

```ts title="plugins/start-pg-world.ts" lineNumbers
import { defineNitroPlugin } from "nitro/~internal/runtime/plugin";

export default defineNitroPlugin(async () => {
  if (process.env.WORKFLOW_TARGET_WORLD === "@workflow/world-postgres") {
    // Dynamic import to avoid edge runtime bundling issues
    console.log("Starting Postgres World...");
    const { getWorld } = await import("workflow/runtime");
    await getWorld().start?.();
    console.log("Postgres World started");
  }
});
```

å°†è¯¥æ’ä»¶æ·»åŠ åˆ°ä½ çš„ `nitro.config.ts` æ–‡ä»¶ä¸­ä»¥å¯ç”¨æ’ä»¶ï¼š

```ts title="nitro.config.ts"
import { defineNitroConfig } from "nitropack";

export default defineNitroConfig({
  // ... your nitro config
  modules: ["workflow/nitro"],
  plugins: ["plugins/start-pg-world.ts"],
});
```

<Callout>
  äº†è§£æœ‰å…³ [Nitro æ’ä»¶](https://v3.nitro.build/docs/plugins) çš„æ›´å¤šä¿¡æ¯ã€‚
</Callout>

</Step>

</Steps>

## å·¥ä½œåŸç†

Postgres World ä½¿ç”¨ PostgreSQL ä½œä¸ºå·¥ä½œæµæ‰§è¡Œçš„æŒä¹…åŒ–åç«¯ï¼š

- **ä½œä¸šé˜Ÿåˆ—**ï¼šä½¿ç”¨ [pg-boss](https://github.com/timgit/pg-boss) ä»¥å®ç°å¯é çš„ä½œä¸šå¤„ç†
- **äº‹ä»¶æµ**ï¼šåˆ©ç”¨ PostgreSQL çš„ NOTIFY/LISTEN è¿›è¡Œå®æ—¶äº‹ä»¶åˆ†å‘
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ‰€æœ‰å·¥ä½œæµçŠ¶æ€éƒ½å­˜å‚¨åœ¨ PostgreSQL è¡¨ä¸­
- **å·¥ä½œç®¡ç†**ï¼šæ”¯æŒå¯é…ç½®çš„å¹¶å‘å·¥ä½œçº¿ç¨‹æ¥å¤„ç†ä½œä¸š

è¯¥è®¾ç½®å¯ç¡®ä¿ä½ çš„å·¥ä½œæµèƒ½å¤Ÿåœ¨åº”ç”¨é‡å¯å’Œæ•…éšœä¸­å­˜æ´»ï¼Œæ‰€æœ‰çŠ¶æ€å¯é åœ°æŒä¹…åŒ–åˆ° PostgreSQL æ•°æ®åº“ä¸­ã€‚
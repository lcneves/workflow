---
title: Nitro
description: Ce guide vous expliquera comment configurer votre premier workflow dans un projet Nitro v3. En cours de route, vous en apprendrez davantage sur les concepts fondamentaux pour utiliser le kit de développement dans vos propres projets.
---

<Steps>

<Step>
## Créer votre projet Nitro

Commencez par créer un nouveau projet [Nitro v3](https://v3.nitro.build/). Cette commande créera un nouveau répertoire nommé `nitro-app` et configurera un projet Nitro à l'intérieur.

```bash
npx create-nitro-app
```

Entrez dans le répertoire créé :

```bash
cd nitro-app
```

### Installer `workflow`

```package-install
npm i workflow
```

### Configurer Nitro

Ajoutez le module `workflow/nitro` à votre `nitro.config.ts`. Cela permet l'utilisation des directives `"use workflow"` et `"use step"`.

```typescript title="nitro.config.ts" lineNumbers
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./server",
  modules: ["workflow/nitro"],
});

```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="[&_p]:my-0 text-lg [&_p]:text-foreground">
      Configurer IntelliSense pour TypeScript (optionnel)
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">
Pour activer les suggestions dans votre IDE, configurez le plugin workflow dans `tsconfig.json` :

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>

  </AccordionItem>
</Accordion>

</Step>

<Step>

## Créez votre premier workflow

Créez un nouveau fichier pour notre premier workflow :

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
  "use workflow"; // [!code highlight]

  const user = await createUser(email);
  await sendWelcomeEmail(user);

  await sleep("5s"); // Pause for 5s - doesn't consume any resources
  await sendOnboardingEmail(user);

  console.log("Workflow is complete! Run 'npx workflow web' to inspect your run")

  return { userId: user.id, status: "onboarded" };
}
```

Nous compléterons ces fonctions ensuite, mais examinons d'abord ce code :

- Nous définissons une fonction **workflow** avec la directive `"use workflow"`. Considérez la fonction workflow comme l’_orchestrateur_ des **étapes** individuelles.
- La fonction `sleep` du Workflow DevKit permet de suspendre l'exécution du workflow sans consommer de ressources. Un sleep peut durer quelques secondes, heures, jours, voire des mois.

## Créer les étapes de votre workflow

Définissons maintenant ces fonctions manquantes.

```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow";

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]

  console.log(`Creating user with email: ${email}`);

  // Full Node.js access - database calls, APIs, etc.
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]

  console.log(`Sending welcome email to user: ${user.id}`);

  if (Math.random() < 0.3) {
    // By default, steps will be retried for unhandled errors
    throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]

  if (!user.email.includes("@")) {
    // To skip retrying, throw a FatalError instead
    throw new FatalError("Invalid Email");
  }

  console.log(`Sending onboarding email to user: ${user.id}`);
}
```

En regardant ce code :

- La logique métier se trouve à l'intérieur des **étapes**. Lorsqu'une étape est invoquée à l'intérieur d'un **workflow**, elle est mise en file d'attente pour s'exécuter dans une requête séparée pendant que le workflow est suspendu, tout comme `sleep`.
- Si une étape lance une erreur, comme dans `sendWelcomeEmail`, elle sera automatiquement réessayée jusqu'à réussir (ou jusqu'à atteindre le nombre maximal de tentatives de l'étape).
- Les étapes peuvent lancer une `FatalError` si une erreur est intentionnelle et ne doit pas être réessayée.

<Callout>
  Nous approfondirons les workflows, les étapes et d'autres manières de suspendre ou de gérer des événements dans [Fondations](/docs/foundations).
</Callout>

</Step>

<Step>

## Créer votre gestionnaire de route

Pour invoquer votre nouveau workflow, nous allons créer un nouveau gestionnaire de route API à `server/api/signup.post.ts` avec le code suivant :

```typescript title="server/api/signup.post.ts"
import { start } from "workflow/api";
import { defineEventHandler } from "nitro/h3";
import { handleUserSignup } from "../../workflows/user-signup";

export default defineEventHandler(async ({ req }) => {
  const { email } = await req.json() as { email: string };
  // Executes asynchronously and doesn't block your app
  await start(handleUserSignup, [email]);
  return {
    message: "User signup workflow started",
  }
});
```

Ce gestionnaire de route crée un endpoint `POST` à `/api/signup` qui déclenchera votre workflow.

<Callout>
  Les workflows peuvent être déclenchés depuis des routes API ou tout code côté serveur.
</Callout>

</Step>

<Step>

## Exécuter en développement

Pour démarrer votre serveur de développement, exécutez la commande suivante dans votre terminal depuis le répertoire racine de Nitro :

```bash
npm run dev
```

Une fois votre serveur de développement en cours d'exécution, vous pouvez déclencher votre workflow en exécutant cette commande dans le terminal :

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Consultez les logs du serveur de développement Nitro pour voir l'exécution de votre workflow ainsi que les étapes en cours de traitement.

De plus, vous pouvez utiliser la [CLI ou l'interface Web du Workflow DevKit](/docs/observability) pour inspecter en détail vos exécutions de workflow et les étapes.

```bash
# Open the observability Web UI
npx workflow web
# or if you prefer a terminal interface, use the CLI inspect command
npx workflow inspect runs
```

<img src="/o11y-ui.png" alt="Interface Web du Workflow DevKit" />

</Step>

</Steps>

## Déployer en production

Les applications Workflow DevKit fonctionnent actuellement mieux lorsqu'elles sont déployées sur [Vercel](https://vercel.com/home) et ne nécessitent aucune configuration spéciale.

Consultez la section [Déploiement](/docs/deploying) pour savoir comment déployer vos workflows ailleurs.

## Étapes suivantes

- En savoir plus sur les [Fondations](/docs/foundations).
- Consultez [Erreurs](/docs/errors) si vous rencontrez des problèmes.
- Explorez la [Référence API](/docs/api-reference).
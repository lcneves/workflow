---
title: Fastify
---

This guide will walk through setting up your first workflow in a Fastify app. Along the way, you'll learn more about the concepts that are fundamental to using the development kit in your own projects.

---

<Steps>

<Step>
## Crea tu proyecto Fastify

Empieza creando un nuevo proyecto Fastify.

```bash
mkdir my-workflow-app
```

Entra en el directorio recién creado:

```bash
cd my-workflow-app
```

Inicializa el proyecto:

```bash
npm init --y
```

### Instala `workflow`, `fastify` y `nitro`

```package-install
npm i workflow fastify nitro rollup
```

<Callout>
Por defecto, Fastify no incluye un sistema de build. Nitro añade uno que permite compilar workflows, ejecutar runs y desplegar para desarrollo y producción. Aprende más sobre [Nitro](https://v3.nitro.build).
</Callout>

Si usas TypeScript, necesitas instalar los paquetes `@types/node` y `typescript`

```bash
npm i -D @types/node typescript
```

### Configura Nitro

Crea un nuevo archivo `nitro.config.ts` para tu configuración de Nitro con el módulo `workflow/nitro`. Esto habilita el uso de las directivas `"use workflow"` y `"use step"`

```typescript title="nitro.config.ts" lineNumbers
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
	modules: ["workflow/nitro"],
	vercel: { entryFormat: "node" },
	routes: {
		"/**": { handler: "./src/index.ts", format: "node" },
	},
});
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="[&_p]:my-0 text-lg [&_p]:text-foreground">
      Configurar IntelliSense para TypeScript (Opcional)
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">
Para habilitar sugerencias útiles en tu IDE, configura el plugin de workflow en `tsconfig.json`:

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

### Actualiza `package.json`

Para usar el builder de Nitro, actualiza tu `package.json` para incluir los siguientes scripts:

```json title="package.json" lineNumbers
{
  // ...
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  // ...
}
```

</Step>

<Step>

## Crea tu primer flujo de trabajo

Crea un nuevo archivo para nuestro primer flujo de trabajo:

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
  "use workflow"; // [!code highlight]

  const user = await createUser(email);
  await sendWelcomeEmail(user);

  await sleep("5s"); // Pause for 5s - doesn't consume any resources
  await sendOnboardingEmail(user);

  return { userId: user.id, status: "onboarded" };
}
```

Rellenaremos esas funciones a continuación, pero echemos un vistazo a este código:

- Definimos una función de **flujo de trabajo** con la directiva `"use workflow"`. Piensa en la función de flujo de trabajo como el _orquestador_ de los **pasos** individuales.
- La función `sleep` del Workflow DevKit nos permite suspender la ejecución del flujo de trabajo sin consumir recursos. Un sleep puede durar unos segundos, horas, días o incluso meses.
## Crea los pasos de tu flujo de trabajo

Ahora definamos esas funciones faltantes:
```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow";

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]
  console.log(`Creating user with email: ${email}`);
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  console.log(`Sending welcome email to user: ${user.id}`);
  if (Math.random() < 0.3) {
    // Steps retry on unhandled errors
    throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  if (!user.email.includes("@")) {
    // FatalError skips retries
    throw new FatalError("Invalid Email");
  }
  console.log(`Sending onboarding email to user: ${user.id}`);
}
```
Al observar este código:

- La lógica de negocio reside dentro de los **pasos**. Cuando se invoca un paso dentro de un **flujo de trabajo**, se encola para ejecutarse en una petición separada mientras el flujo de trabajo está suspendido, al igual que `sleep`.
- Si un paso lanza un error, como en `sendWelcomeEmail`, el paso se volverá a intentar automáticamente hasta que tenga éxito (o alcance el recuento máximo de reintentos del paso).
- Los pasos pueden lanzar un `FatalError` si el error es intencional y no debe reintentarse.

<Callout>
  Profundizaremos en flujos de trabajo, pasos y otras formas de suspender o manejar eventos en [Fundamentos](/docs/foundations).
</Callout>
</Step>

<Step>

## Crea el manejador de ruta

Para invocar tu nuevo flujo de trabajo, crearemos tanto la app de Fastify como un nuevo manejador de ruta API en `src/index.ts` con el siguiente código:

```typescript title="src/index.ts"
import Fastify from "fastify";
import { start } from "workflow/api";
import { handleUserSignup } from "../workflows/user-signup.js";

const app = Fastify({ logger: true });
app.post("/api/signup", async (req, reply) => {
  const { email } = req.body as { email: string };
  await start(handleUserSignup, [email]);
  return reply.send({ message: "User signup workflow started" });
});

// Wait for Fastify to be ready before handling requests
await app.ready();


export default (req: any, res: any) => {
  app.server.emit("request", req, res);
};
```
Este manejador de ruta crea un endpoint de tipo `POST` en `/api/signup` que disparará tu flujo de trabajo.
</Step>

<Step>

## Ejecutar en desarrollo

Para iniciar tu servidor de desarrollo, ejecuta el siguiente comando en tu terminal en el directorio raíz de Fastify:

```bash
npm run dev
```

Una vez que tu servidor de desarrollo esté en funcionamiento, puedes activar tu flujo de trabajo ejecutando este comando en la terminal:

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Revisa los registros del servidor de desarrollo de Fastify para ver la ejecución de tu flujo de trabajo, así como los pasos que se están procesando.

Además, puedes usar la [CLI o interfaz web de Workflow DevKit](/docs/observability) para inspeccionar las ejecuciones de tus flujos de trabajo y los pasos en detalle.

```bash
npx workflow inspect runs # add '--web' for an interactive Web based UI
```

<img src="/o11y-ui.png" alt="Interfaz web de Workflow DevKit" />

</Step>

</Steps>

---

## Desplegar a producción

Las aplicaciones de Workflow DevKit actualmente funcionan mejor cuando se despliegan en [Vercel](https://vercel.com/home) y no requieren configuración especial.

Consulta la sección [Despliegue](/docs/deploying) para aprender cómo se pueden desplegar tus flujos de trabajo en otros entornos.

## Siguientes pasos

- Aprende más sobre los [Fundamentos](/docs/foundations).
- Consulta [Errores](/docs/errors) si encuentras problemas.
- Explora la [Referencia de la API](/docs/api-reference).
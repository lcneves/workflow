---
title: Fastify
---

Este guia irá orientar você na configuração do seu primeiro workflow em um aplicativo Fastify. Ao longo do caminho, você aprenderá mais sobre os conceitos fundamentais para usar o kit de desenvolvimento em seus próprios projetos.

---

<Steps>

<Step>
## Crie seu projeto Fastify

Comece criando um novo projeto Fastify.

```bash
mkdir my-workflow-app
```

Entre no diretório recém-criado:

```bash
cd my-workflow-app
```

Inicialize o projeto:

```bash
npm init --y
```

### Instale `workflow`, `fastify` e `nitro`

```package-install
npm i workflow fastify nitro rollup
```

<Callout>
Por padrão, o Fastify não inclui um sistema de build. O Nitro adiciona um, permitindo compilar workflows, runs e deploys para desenvolvimento e produção. Saibam mais sobre [Nitro](https://v3.nitro.build).
</Callout>

Se estiver usando TypeScript, você precisa instalar os pacotes `@types/node` e `typescript`

```bash
npm i -D @types/node typescript
```

### Configure o Nitro

Crie um novo arquivo `nitro.config.ts` para sua configuração do Nitro com o módulo `workflow/nitro`. Isso habilita o uso das diretivas `"use workflow"` e `"use step"`

```typescript title="nitro.config.ts" lineNumbers
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
	modules: ["workflow/nitro"],
	vercel: { entryFormat: "node" },
	routes: {
		"/**": { handler: "./src/index.ts", format: "node" },
	},
});
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="[&_p]:my-0 text-lg [&_p]:text-foreground">
      Configurar o IntelliSense para TypeScript (Opcional)
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">
Para habilitar sugestões úteis em sua IDE, configure o plugin workflow em `tsconfig.json`:

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

### Atualize o `package.json`

Para usar o builder do Nitro, atualize seu `package.json` para incluir os seguintes scripts:

```json title="package.json" lineNumbers
{
  // ...
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  // ...
}
```

</Step>

<Step>

## Crie seu primeiro workflow

Crie um novo arquivo para o nosso primeiro workflow:

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
  "use workflow"; // [!code highlight]

  const user = await createUser(email);
  await sendWelcomeEmail(user);

  await sleep("5s"); // Pause for 5s - doesn't consume any resources
  await sendOnboardingEmail(user);

  return { userId: user.id, status: "onboarded" };
}
```

Vamos preencher essas funções a seguir, mas dê uma olhada neste código:

- Nós definimos uma **workflow** function com a diretiva `"use workflow"`. Pense na função workflow como o _orquestrador_ de **steps** individuais.
- A função `sleep` do Workflow DevKit permite suspender a execução do workflow sem consumir recursos. Um sleep pode durar alguns segundos, horas, dias ou até meses.
## Crie os steps do seu workflow

Agora vamos definir essas funções faltantes:
```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow";

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]
  console.log(`Creating user with email: ${email}`);
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  console.log(`Sending welcome email to user: ${user.id}`);
  if (Math.random() < 0.3) {
    // Steps retry on unhandled errors
    throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  if (!user.email.includes("@")) {
    // FatalError skips retries
    throw new FatalError("Invalid Email");
  }
  console.log(`Sending onboarding email to user: ${user.id}`);
}
```
Analisando este código:

- A lógica de negócio fica dentro dos **steps**. Quando um step é invocado dentro de um **workflow**, ele é enfileirado para execução em uma requisição separada enquanto o workflow fica suspenso, assim como `sleep`.
- Se um step lançar um erro, como em `sendWelcomeEmail`, o step será automaticamente tentado novamente até que tenha sucesso (ou atinja o número máximo de retries do step).
- Steps podem lançar um `FatalError` se o erro for intencional e não dever ser re-tentado.

<Callout>
  Aprofundaremos workflows, steps e outras formas de suspender ou tratar eventos em [Fundamentos](/docs/foundations).
</Callout>
</Step>

<Step>

## Crie seu manipulador de rota

Para invocar seu novo workflow, vamos criar tanto o app Fastify quanto um novo manipulador de rota API em `src/index.ts` com o código a seguir:

```typescript title="src/index.ts"
import Fastify from "fastify";
import { start } from "workflow/api";
import { handleUserSignup } from "../workflows/user-signup.js";

const app = Fastify({ logger: true });
app.post("/api/signup", async (req, reply) => {
  const { email } = req.body as { email: string };
  await start(handleUserSignup, [email]);
  return reply.send({ message: "User signup workflow started" });
});

// Wait for Fastify to be ready before handling requests
await app.ready();


export default (req: any, res: any) => {
  app.server.emit("request", req, res);
};
```
Este manipulador de rota cria um endpoint de requisição `POST` em `/api/signup` que irá acionar o seu workflow.
</Step>

<Step>

## Executar em desenvolvimento

Para iniciar seu servidor de desenvolvimento, execute o seguinte comando no terminal na raiz do projeto Fastify:

```bash
npm run dev
```

Uma vez que o servidor de desenvolvimento esteja em execução, você pode acionar seu workflow executando este comando no terminal:

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Verifique os logs do servidor de desenvolvimento do Fastify para ver a execução do seu workflow, bem como os steps que estão sendo processados.

Além disso, você pode usar a [CLI ou UI Web do Workflow DevKit](/docs/observability) para inspecionar suas runs e steps em detalhe.

```bash
npx workflow inspect runs # add '--web' for an interactive Web based UI
```

<img src="/o11y-ui.png" alt="Interface Web do Workflow DevKit" />

</Step>

</Steps>

---

## Implantação em produção

Os aplicativos Workflow DevKit atualmente funcionam melhor quando implantados no Vercel e não exigem configuração especial.

Consulte a seção [Implantação](/docs/deploying) para saber como seus workflows podem ser implantados em outros provedores.

## Próximos passos

- Saiba mais sobre os [Fundamentos](/docs/foundations).
- Verifique os [Erros](/docs/errors) se encontrar problemas.
- Explore a [Referência de API](/docs/api-reference).
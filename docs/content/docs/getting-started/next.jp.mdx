---
title: Next.js
description: このガイドでは、Next.jsアプリで最初のワークフローを設定する方法を説明します。途中で、開発キットを自分のプロジェクトで使用するために重要な概念について詳しく学びます。
---

<Steps>

<Step>
## Next.js プロジェクトを作成する

まず、新しい Next.js プロジェクトを作成します。このコマンドは `my-workflow-app` という名前の新しいディレクトリを作成し、その中に Next.js プロジェクトをセットアップします。

```bash
npm create next-app@latest my-workflow-app
```

作成されたディレクトリに移動します:

```bash
cd my-workflow-app
```

### `workflow` をインストールする

```package-install
npm i workflow
```

### Next.js を設定する

`next.config.ts` を `withWorkflow()` でラップします。これにより `"use workflow"` と `"use step"` ディレクティブが利用可能になります。

```typescript title="next.config.ts" lineNumbers
import { withWorkflow } from "workflow/next"; // [!code highlight]
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // … rest of your Next.js config
};

export default withWorkflow(nextConfig); // [!code highlight]
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="text-sm">
      ### TypeScript の IntelliSense を設定する（任意）
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">

IDE で便利なヒントを有効にするには、`tsconfig.json` に workflow プラグインを設定します:

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="text-sm">
      ### プロキシハンドラーを構成する（該当する場合）
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">

Next.js アプリに [プロキシハンドラー](https://nextjs.org/docs/app/api-reference/file-conventions/proxy)
（以前は "middleware" として知られていました）がある場合、ワークフローの内部パスがプロキシハンドラーで処理されないように、
matcher パターンを更新して Workflow の内部パスを除外する必要があります。

`.well-known/workflow/*` をミドルウェアの除外リストに追加してください:

```typescript title="proxy.ts" lineNumbers
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function proxy(request: NextRequest) {
  // Your middleware logic
  return NextResponse.next();
}

export const config = {
  matcher: [
    // ... your existing matchers
    {
      source: "/((?!_next/static|_next/image|favicon.ico|.well-known/workflow/).*)", // [!code highlight]
    },
  ],
};
```

これにより、Workflow の内部パスがミドルウェアにより横取りされることがなくなり、ワークフローの実行や再開に干渉するのを防げます。
    </AccordionContent>
  </AccordionItem>
</Accordion>

</Step>

<Step>

## 最初のワークフローを作成する

最初のワークフロー用の新しいファイルを作成します:

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
 "use workflow"; // [!code highlight]

 const user = await createUser(email);
 await sendWelcomeEmail(user);

 await sleep("5s"); // Pause for 5s - doesn't consume any resources
 await sendOnboardingEmail(user);

 console.log("Workflow is complete! Run 'npx workflow web' to inspect your run")

 return { userId: user.id, status: "onboarded" };
}

```

次にこれらの関数を実装しますが、まずこのコードを見てみましょう:

* ディレクティブ `"use workflow"` を使って **workflow** 関数を定義します。workflow 関数は個々の **steps** の _オーケストレーター_ と考えてください。
* Workflow DevKit の `sleep` 関数は、ワークフローの実行をリソースを消費せずに一時停止することを可能にします。sleep は数秒、数時間、数日、あるいは数か月に及ぶことがあります。

## ワークフローステップを作成する

では、先ほどの未定義の関数を定義しましょう。

```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow"

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]

  console.log(`Creating user with email: ${email}`);

  // Full Node.js access - database calls, APIs, etc.
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string; }) {
  "use step"; // [!code highlight]

  console.log(`Sending welcome email to user: ${user.id}`);

  if (Math.random() < 0.3) {
  // By default, steps will be retried for unhandled errors
   throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string}) {
 "use step"; // [!code highlight]

  if (!user.email.includes("@")) {
    // To skip retrying, throw a FatalError instead
    throw new FatalError("Invalid Email");
  }

 console.log(`Sending onboarding email to user: ${user.id}`);
}
```

このコードを見てみると:

* ビジネスロジックは **steps** 内に存在します。ステップが **workflow** 内で呼び出されると、そのステップはワークフローが一時停止している間に別のリクエスト上で実行されるようにキューに入れられ、`sleep` と同様に扱われます。
* `sendWelcomeEmail` のようにステップがエラーを投げた場合、そのステップは成功するまで（またはステップの最大リトライ回数に達するまで）自動的にリトライされます。
* エラーが意図的でリトライを避けたい場合、ステップは `FatalError` をスローできます。

<Callout>
ワークフロー、ステップ、およびイベントを一時停止または処理する他の方法については、[Foundations](/docs/foundations) で詳しく説明します。
</Callout>

</Step>

<Step>

## ルートハンドラを作成する

新しいワークフローを呼び出すには、`POST` API ルートハンドラ `app/api/signup/route.ts` にワークフローを追加する必要があります。以下のコードを使用します:

```typescript title="app/api/signup/route.ts"
import { start } from "workflow/api";
import { handleUserSignup } from "@/workflows/user-signup";
import { NextResponse } from "next/server";

export async function POST(request: Request) {
 const { email } = await request.json();

 // Executes asynchronously and doesn't block your app
 await start(handleUserSignup, [email]);

 return NextResponse.json({
  message: "User signup workflow started",
 });
}
```

このルートハンドラは `/api/signup` に `POST` リクエストのエンドポイントを作成し、ワークフローをトリガーします。

<Callout>
ワークフローは API ルート、Server Actions、または任意のサーバーサイドコードからトリガーできます。
</Callout>

</Step>

</Steps>

## 開発環境で実行する

開発サーバーを起動するには、Next.js ルートディレクトリのターミナルで次のコマンドを実行します:

```bash
npm run dev
```

開発サーバーが起動したら、次のコマンドをターミナルで実行してワークフローをトリガーできます:

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Next.js の開発サーバーログを確認して、ワークフローの実行および処理されているステップを確認してください。

さらに、[Workflow DevKit CLI または Web UI](/docs/observability) を使用して、ワークフローの実行やステップを詳しく検査できます。

```bash
# Open the observability Web UI
npx workflow web
# or if you prefer a terminal interface, use the CLI inspect command
npx workflow inspect runs
```

<img src="/o11y-ui.png" alt="Workflow DevKit の Web UI" />

## 本番環境へのデプロイ

Workflow DevKit アプリは現時点では [Vercel](https://vercel.com/home) にデプロイする場合に最もよく動作し、特別な設定は不要です。

ワークフローを他の環境にデプロイする方法については、[Deploying](/docs/deploying) セクションを確認してください。

## 次のステップ

* [Foundations](/docs/foundations) について詳しく学ぶ。
* 問題が発生した場合は [Errors](/docs/errors) を確認する。
* [API Reference](/docs/api-reference) を参照する。
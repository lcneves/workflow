---
title: Next.js
description: Esta guía te guiará en la configuración de tu primer flujo de trabajo en una aplicación Next.js. A lo largo del proceso, aprenderás más sobre los conceptos que son fundamentales para usar el kit de desarrollo en tus propios proyectos.
---

<Steps>

<Step>
## Crea tu proyecto Next.js

Empieza creando un nuevo proyecto Next.js. Este comando creará un nuevo directorio llamado `my-workflow-app` y configurará un proyecto Next.js en su interior.

```bash
npm create next-app@latest my-workflow-app
```

Entra en el directorio recién creado:

```bash
cd my-workflow-app
```

### Instala `workflow`

```package-install
npm i workflow
```

### Configura Next.js

Envuelve tu `next.config.ts` con `withWorkflow()`. Esto permite el uso de las directivas `"use workflow"` y `"use step"`.

```typescript title="next.config.ts" lineNumbers
import { withWorkflow } from "workflow/next"; // [!code highlight]
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // … rest of your Next.js config
};

export default withWorkflow(nextConfig); // [!code highlight]
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="text-sm">
      ### Configurar IntelliSense para TypeScript (Opcional)
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">

Para habilitar sugerencias útiles en tu IDE, configura el plugin workflow en `tsconfig.json`:

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="text-sm">
      ### Configura el manejador proxy (si aplica)
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">

Si tu aplicación Next.js tiene un [manejador proxy](https://nextjs.org/docs/app/api-reference/file-conventions/proxy)
(anteriormente conocido como "middleware"), necesitarás actualizar el patrón matcher para excluir las rutas internas de Workflow y evitar que el manejador proxy se ejecute en ellas.

Agrega `.well-known/workflow/*` a la lista de exclusiones de tu middleware:

```typescript title="proxy.ts" lineNumbers
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function proxy(request: NextRequest) {
  // Your middleware logic
  return NextResponse.next();
}

export const config = {
  matcher: [
    // ... your existing matchers
    {
      source: "/((?!_next/static|_next/image|favicon.ico|.well-known/workflow/).*)", // [!code highlight]
    },
  ],
};
```

Esto garantiza que las rutas internas de Workflow no sean interceptadas por tu middleware, lo que podría interferir con la ejecución y reanudación de los flujos de trabajo.
    </AccordionContent>
  </AccordionItem>
</Accordion>

</Step>

<Step>

## Crea tu primer flujo de trabajo

Crea un nuevo archivo para nuestro primer flujo de trabajo:

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
 "use workflow"; // [!code highlight]

 const user = await createUser(email);
 await sendWelcomeEmail(user);

 await sleep("5s"); // Pause for 5s - doesn't consume any resources
 await sendOnboardingEmail(user);

 console.log("Workflow is complete! Run 'npx workflow web' to inspect your run")

 return { userId: user.id, status: "onboarded" };
}

```

Completaremos esas funciones a continuación, pero echemos un vistazo a este código:

* Definimos una función **flujo de trabajo** con la directiva `"use workflow"`. Piensa en la función de flujo de trabajo como el _orquestador_ de los **pasos** individuales.
* La función `sleep` del Workflow DevKit nos permite suspender la ejecución del flujo de trabajo sin consumir recursos. Un sleep puede durar unos segundos, horas, días o incluso meses.

## Crea los pasos de tu flujo de trabajo

Ahora definamos esas funciones que faltan.

```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow"

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]

  console.log(`Creating user with email: ${email}`);

  // Full Node.js access - database calls, APIs, etc.
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string; }) {
  "use step"; // [!code highlight]

  console.log(`Sending welcome email to user: ${user.id}`);

  if (Math.random() < 0.3) {
  // By default, steps will be retried for unhandled errors
   throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string}) {
 "use step"; // [!code highlight]

  if (!user.email.includes("@")) {
    // To skip retrying, throw a FatalError instead
    throw new FatalError("Invalid Email");
  }

 console.log(`Sending onboarding email to user: ${user.id}`);
}
```

Al mirar este código:

* La lógica de negocio vive dentro de los **pasos**. Cuando un paso es invocado dentro de un **flujo de trabajo**, se encola para ejecutarse en una solicitud separada mientras el flujo de trabajo está suspendido, igual que `sleep`.
* Si un paso lanza un error, como en `sendWelcomeEmail`, el paso será reintentado automáticamente hasta que tenga éxito (o alcance el número máximo de reintentos del paso).
* Los pasos pueden lanzar un `FatalError` si un error es intencional y no debe reintentarse.

<Callout>
Profundizaremos en los flujos de trabajo, los pasos y otras formas de suspender o manejar eventos en [Fundamentos](/docs/foundations).
</Callout>

</Step>

<Step>

## Crea tu manejador de ruta

Para invocar tu nuevo flujo de trabajo, necesitamos agregarlo a un Route Handler de API `POST`, `app/api/signup/route.ts`, con el siguiente código:

```typescript title="app/api/signup/route.ts"
import { start } from "workflow/api";
import { handleUserSignup } from "@/workflows/user-signup";
import { NextResponse } from "next/server";

export async function POST(request: Request) {
 const { email } = await request.json();

 // Executes asynchronously and doesn't block your app
 await start(handleUserSignup, [email]);

 return NextResponse.json({
  message: "User signup workflow started",
 });
}
```

Este Route Handler crea un endpoint de petición `POST` en `/api/signup` que activará tu flujo de trabajo.

<Callout>
Los flujos de trabajo pueden ser activados desde rutas de API, Server Actions o cualquier código del lado del servidor.
</Callout>

</Step>

</Steps>

## Ejecutar en desarrollo

Para iniciar tu servidor de desarrollo, ejecuta el siguiente comando en tu terminal en el directorio raíz de Next.js:

```bash
npm run dev
```

Una vez que tu servidor de desarrollo esté en funcionamiento, puedes activar tu flujo de trabajo ejecutando este comando en la terminal:

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Revisa los registros del servidor de desarrollo de Next.js para ver la ejecución de tu flujo de trabajo, así como los pasos que se están procesando.

Además, puedes usar la [CLI o la Interfaz Web de Workflow DevKit](/docs/observability) para inspeccionar en detalle tus ejecuciones de flujo de trabajo y pasos.

```bash
# Open the observability Web UI
npx workflow web
# or if you prefer a terminal interface, use the CLI inspect command
npx workflow inspect runs
```

<img src="/o11y-ui.png" alt="Interfaz web del Workflow DevKit" />

## Despliegue en producción

Las aplicaciones de Workflow DevKit funcionan mejor actualmente cuando se despliegan en [Vercel](https://vercel.com/home) y no requieren configuración especial.

Consulta la sección [Despliegue](/docs/deploying) para aprender cómo se pueden desplegar tus flujos de trabajo en otros entornos.

## Siguientes pasos

* Obtén más información sobre [Fundamentos](/docs/foundations).
* Consulta [Errores](/docs/errors) si encuentras problemas.
* Explora la [Referencia de la API](/docs/api-reference).
---
title: Fastify
---

本指南将引导你在 Fastify 应用中设置第一个工作流。在此过程中，你将学习在自己的项目中使用开发工具包所必需的核心概念。

---

<Steps>

<Step>
## 创建你的 Fastify 项目

首先创建一个新的 Fastify 项目。

```bash
mkdir my-workflow-app
```

进入新建的目录：

```bash
cd my-workflow-app
```

初始化项目：

```bash
npm init --y
```

### 安装 `workflow`、`fastify` 和 `nitro`

```package-install
npm i workflow fastify nitro rollup
```

<Callout>
默认情况下，Fastify 不包含构建系统。Nitro 提供了一个构建系统，使得在开发和生产环境中编译工作流、运行和部署成为可能。了解更多关于 [Nitro](https://v3.nitro.build) 的信息。
</Callout>

如果使用 TypeScript，需要安装 `@types/node` 和 `typescript` 包

```bash
npm i -D @types/node typescript
```

### 配置 Nitro

为你的 Nitro 配置创建一个新的文件 `nitro.config.ts`，并使用模块 `workflow/nitro`。这将启用对 `"use workflow"` 和 `"use step"` 指令的使用

```typescript title="nitro.config.ts" lineNumbers
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
	modules: ["workflow/nitro"],
	vercel: { entryFormat: "node" },
	routes: {
		"/**": { handler: "./src/index.ts", format: "node" },
	},
});
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="[&_p]:my-0 text-lg [&_p]:text-foreground">
      为 TypeScript 设置 IntelliSense（可选）
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">
要在你的 IDE 中启用有用的提示，请在 `tsconfig.json` 中设置 workflow 插件：

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

### 更新 `package.json`

要使用 Nitro 构建器，请更新你的 `package.json`，添加以下脚本：

```json title="package.json" lineNumbers
{
  // ...
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  // ...
}
```

</Step>

<Step>

## 创建你的第一个工作流

为我们的第一个工作流创建一个新文件：

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
  "use workflow"; // [!code highlight]

  const user = await createUser(email);
  await sendWelcomeEmail(user);

  await sleep("5s"); // Pause for 5s - doesn't consume any resources
  await sendOnboardingEmail(user);

  return { userId: user.id, status: "onboarded" };
}
```

接下来我们会实现那些函数，但先来看看这段代码：

- 我们使用指令 "use workflow" 定义了一个 **工作流** 函数。可以将工作流函数视为各个 **步骤** 的协调者。
- Workflow DevKit 的 `sleep` 函数允许我们在不消耗任何资源的情况下挂起工作流的执行。sleep 可以是几秒、几小时、几天，甚至几个月长。
## 创建工作流的步骤

现在定义那些缺失的函数：
```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow";

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]
  console.log(`Creating user with email: ${email}`);
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  console.log(`Sending welcome email to user: ${user.id}`);
  if (Math.random() < 0.3) {
    // Steps retry on unhandled errors
    throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  if (!user.email.includes("@")) {
    // FatalError skips retries
    throw new FatalError("Invalid Email");
  }
  console.log(`Sending onboarding email to user: ${user.id}`);
}
```
看一下这段代码：

- 业务逻辑位于 **步骤** 内。当在 **工作流** 中调用一个步骤时，该步骤会被排入队列，在工作流挂起期间于单独的请求中运行，就像 `sleep` 一样。
- 如果某个步骤抛出错误（例如 `sendWelcomeEmail`），该步骤将自动重试，直到成功（或达到步骤的最大重试次数）。
- 如果错误是有意为之且不应重试，步骤可以抛出 `FatalError`。

<Callout>
  我们将在 [基础](/docs/foundations) 中更深入地探讨工作流、步骤以及其他挂起或处理事件的方法。
</Callout>
</Step>

<Step>

## 创建路由处理器

为了调用你的新工作流，我们将在 `src/index.ts` 中创建 Fastify 应用和一个新的 API 路由处理器，代码如下：

```typescript title="src/index.ts"
import Fastify from "fastify";
import { start } from "workflow/api";
import { handleUserSignup } from "../workflows/user-signup.js";

const app = Fastify({ logger: true });
app.post("/api/signup", async (req, reply) => {
  const { email } = req.body as { email: string };
  await start(handleUserSignup, [email]);
  return reply.send({ message: "User signup workflow started" });
});

// Wait for Fastify to be ready before handling requests
await app.ready();


export default (req: any, res: any) => {
  app.server.emit("request", req, res);
};
```
此路由处理器在 `/api/signup` 创建了一个 `POST` 请求端点，用于触发你的工作流。
</Step>

<Step>

## 在开发环境中运行

要启动开发服务器，请在 Fastify 根目录的终端中运行以下命令：

```bash
npm run dev
```

开发服务器启动后，可通过在终端运行以下命令来触发你的工作流：

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

查看 Fastify 开发服务器日志以观察工作流的执行以及正在处理的步骤。

此外，你可以使用 [Workflow DevKit CLI 或 Web UI](/docs/observability) 详细查看工作流运行和步骤。

```bash
npx workflow inspect runs # add '--web' for an interactive Web based UI
```

<img src="/o11y-ui.png" alt="Workflow DevKit Web 界面" />

</Step>

</Steps>

---

## 部署到生产环境

Workflow DevKit 应用目前在部署到 [Vercel](https://vercel.com/home) 时效果最佳，且无需特殊配置。

查看 [部署](/docs/deploying) 一节，了解如何将你的工作流部署到其他环境。

## 下一步

- 了解更多关于 [基础](/docs/foundations) 的内容。
- 如果遇到问题，请查看 [错误](/docs/errors)。
- 浏览 [API 参考](/docs/api-reference)。
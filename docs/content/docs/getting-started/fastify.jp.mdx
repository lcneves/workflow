---
title: Fastify
---

このガイドでは、Fastify アプリで最初のワークフローを設定する手順を説明します。途中で、開発キットを自分のプロジェクトで使用する際に重要となる概念についても学びます。

---

<Steps>

<Step>
## Fastify プロジェクトを作成する

まず新しい Fastify プロジェクトを作成します。

```bash
mkdir my-workflow-app
```

作成したディレクトリに移動します:

```bash
cd my-workflow-app
```

プロジェクトを初期化します:

```bash
npm init --y
```

### `workflow`、`fastify`、および `nitro` をインストールする

```package-install
npm i workflow fastify nitro rollup
```

<Callout>
デフォルトでは Fastify にビルドシステムは含まれていません。Nitro はビルド機能を追加し、ワークフロー、ラン、デプロイのコンパイルを開発・本番環境で可能にします。詳細は [Nitro](https://v3.nitro.build) をご覧ください。
</Callout>

TypeScript を使用する場合は、`@types/node` と `typescript` パッケージをインストールする必要があります

```bash
npm i -D @types/node typescript
```

### Nitro の設定

モジュール `workflow/nitro` を使用する Nitro の設定として、新しいファイル `nitro.config.ts` を作成します。これにより `"use workflow"` および `"use step"` ディレクティブを使用できるようになります

```typescript title="nitro.config.ts" lineNumbers
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
	modules: ["workflow/nitro"],
	vercel: { entryFormat: "node" },
	routes: {
		"/**": { handler: "./src/index.ts", format: "node" },
	},
});
```

<Accordion type="single" collapsible>
  <AccordionItem value="typescript-intellisense" className="[&_h3]:my-0">
    <AccordionTrigger className="[&_p]:my-0 text-lg [&_p]:text-foreground">
      TypeScript の IntelliSense を設定する（任意）
    </AccordionTrigger>
    <AccordionContent className="[&_p]:my-2">
IDE で役立つヒントを有効にするには、`tsconfig.json` に workflow プラグインを設定します：

```json title="tsconfig.json" lineNumbers
{
  "compilerOptions": {
    // ... rest of your TypeScript config
    "plugins": [
      {
        "name": "workflow" // [!code highlight]
      }
    ]
  }
}
```

    </AccordionContent>
  </AccordionItem>
</Accordion>

### `package.json` を更新する

Nitro ビルダーを使用するには、`package.json` を更新して次のスクリプトを追加します：

```json title="package.json" lineNumbers
{
  // ...
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  // ...
}
```

</Step>

<Step>

## 最初のワークフローを作成する

最初のワークフロー用の新しいファイルを作成します：

```typescript title="workflows/user-signup.ts" lineNumbers
import { sleep } from "workflow";

export async function handleUserSignup(email: string) {
  "use workflow"; // [!code highlight]

  const user = await createUser(email);
  await sendWelcomeEmail(user);

  await sleep("5s"); // Pause for 5s - doesn't consume any resources
  await sendOnboardingEmail(user);

  return { userId: user.id, status: "onboarded" };
}
```

次にそれらの関数を実装しますが、まずはこのコードを見てみましょう：

- ディレクティブ `"use workflow"` を使用して **workflow** 関数を定義します。workflow 関数は個々の **steps** の _オーケストレーター_ と考えてください。
- Workflow DevKit の `sleep` 関数は、リソースを消費することなくワークフローの実行を一時停止することを可能にします。sleep は数秒、数時間、数日、あるいは数か月にわたることがあります。
## ワークフローステップを作成する

それでは、欠けている関数を定義しましょう：
```typescript title="workflows/user-signup.ts" lineNumbers
import { FatalError } from "workflow";

// Our workflow function defined earlier

async function createUser(email: string) {
  "use step"; // [!code highlight]
  console.log(`Creating user with email: ${email}`);
  return { id: crypto.randomUUID(), email };
}

async function sendWelcomeEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  console.log(`Sending welcome email to user: ${user.id}`);
  if (Math.random() < 0.3) {
    // Steps retry on unhandled errors
    throw new Error("Retryable!");
  }
}

async function sendOnboardingEmail(user: { id: string; email: string }) {
  "use step"; // [!code highlight]
  if (!user.email.includes("@")) {
    // FatalError skips retries
    throw new FatalError("Invalid Email");
  }
  console.log(`Sending onboarding email to user: ${user.id}`);
}
```
このコードを見てみます：

- ビジネスロジックは **steps** の中にあります。step が **workflow** 内で呼び出されると、ワークフローが一時停止している間に別のリクエストで実行されるようキューに入れられます。`sleep` と同様の動作です。
- もし step がエラーを投げた場合（`sendWelcomeEmail` のように）、その step は成功するまで（または step の最大再試行回数に達するまで）自動的に再試行されます。
- 意図的なエラーで再試行すべきでない場合、step は `FatalError` を投げることができます。

<Callout>
  ワークフロー、ステップ、およびイベントを一時停止または処理する他の方法については、[基礎](/docs/foundations) で詳しく説明します。
</Callout>
</Step>

<Step>

## ルートハンドラーを作成する

新しいワークフローを呼び出すために、Fastify アプリと `src/index.ts` に新しい API ルートハンドラーの両方を作成します。以下のコードを参照してください：

```typescript title="src/index.ts"
import Fastify from "fastify";
import { start } from "workflow/api";
import { handleUserSignup } from "../workflows/user-signup.js";

const app = Fastify({ logger: true });
app.post("/api/signup", async (req, reply) => {
  const { email } = req.body as { email: string };
  await start(handleUserSignup, [email]);
  return reply.send({ message: "User signup workflow started" });
});

// Wait for Fastify to be ready before handling requests
await app.ready();


export default (req: any, res: any) => {
  app.server.emit("request", req, res);
};
```
このルートハンドラーは、ワークフローをトリガーする `/api/signup` の `POST` エンドポイントを作成します。
</Step>

<Step>

## 開発環境での実行

開発サーバーを起動するには、Fastify ルートディレクトリでターミナルに次のコマンドを入力します：

```bash
npm run dev
```

開発サーバーが起動したら、次のコマンドをターミナルで実行してワークフローをトリガーできます：

```bash
curl -X POST --json '{"email":"hello@example.com"}' http://localhost:3000/api/signup
```

Fastify 開発サーバーのログを確認すると、ワークフローの実行や処理されているステップを確認できます。

さらに、[Workflow DevKit の CLI または Web UI](/docs/observability) を使用して、ワークフローの実行やステップを詳細に検査することもできます。

```bash
npx workflow inspect runs # add '--web' for an interactive Web based UI
```

<img src="/o11y-ui.png" alt="Workflow DevKit の Web UI" />

</Step>

</Steps>

---

## 本番環境へのデプロイ

Workflow DevKit アプリは現在、[Vercel](https://vercel.com/home) にデプロイした場合に最も良く動作し、特別な設定は不要です。

ワークフローを他の環境にデプロイする方法については、[デプロイ](/docs/deploying) のセクションを確認してください。

## 次のステップ

- [基礎](/docs/foundations) について詳しく学ぶ。
- 問題が発生したら [エラー](/docs/errors) を確認してください。
- [API リファレンス](/docs/api-reference) を参照してください。